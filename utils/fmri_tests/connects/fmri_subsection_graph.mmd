flowchart LR
  MRIQC["MRIQC / Pipeline"]
  FMRIPREP["fMRIPrep / Pipeline"]

  FSL_DC["FSL / Distortion Correction"]
  FSL_MC["FSL / Motion Correction"]
  FSL_ST["FSL / Slice Timing"]
  FSL_ICA["FSL / ICA-Denoising"]
  FSL_SM["FSL / Smoothing"]
  FSL_STAT["FSL / Statistical Analysis"]

  AFNI_DESP["AFNI / Despiking"]
  AFNI_TEMPFILT["AFNI / Temporal Filtering"]
  AFNI_ST["AFNI / Slice Timing"]
  AFNI_REG["AFNI / Registration"]
  AFNI_MC["AFNI / Motion Correction"]
  AFNI_SM["AFNI / Smoothing"]
  AFNI_MASK["AFNI / Masking"]
  AFNI_STAT["AFNI / Statistical Analysis"]
  AFNI_MCMP["AFNI / Multiple Comparisons"]
  AFNI_CONN["AFNI / Connectivity"]
  AFNI_ROI["AFNI / ROI Analysis"]

  ANTS_MC["ANTs / Motion Correction"]
  FS_FUNC["FreeSurfer / Functional Analysis"]
  WB_CIFTI["Connectome Workbench / CIFTI Operations"]
  WB_SURF["Connectome Workbench / Surface Smoothing"]

  %% MRIQC is a QC-only tool (reports/metrics, no image output) â€” kept as isolated node

  %% Intra-subsection self-loops (allow chaining within multi-tool subsections)
  FSL_DC --> FSL_DC
  FSL_STAT --> FSL_STAT
  FSL_ICA --> FSL_ICA
  AFNI_STAT --> AFNI_STAT
  AFNI_CONN --> AFNI_CONN
  AFNI_MCMP --> AFNI_MCMP
  AFNI_SM --> AFNI_SM
  AFNI_ROI --> AFNI_ROI
  FS_FUNC --> FS_FUNC
  WB_CIFTI --> WB_CIFTI
  WB_SURF --> WB_SURF

  %% FSL pipeline
  FSL_DC --> FSL_MC
  FSL_MC --> FSL_ST
  FSL_ST --> FSL_SM
  FSL_SM --> FSL_ICA
  FSL_SM --> FSL_STAT
  FSL_ICA --> FSL_STAT

  %% FSL alternative pipeline orderings (skip steps)
  FSL_MC --> FSL_SM
  FSL_MC --> FSL_ICA
  FSL_MC --> FSL_STAT
  FSL_ST --> FSL_STAT
  FSL_ICA --> FSL_SM

  %% AFNI pipeline (afni_proc.py block order: despike, tshift, align, volreg, blur, mask, scale, regress)
  AFNI_DESP --> AFNI_ST
  AFNI_ST --> AFNI_REG
  AFNI_REG --> AFNI_MC
  AFNI_MC --> AFNI_SM
  AFNI_SM --> AFNI_MASK
  AFNI_MASK --> AFNI_STAT
  AFNI_MASK --> AFNI_TEMPFILT
  AFNI_STAT --> AFNI_MCMP
  AFNI_STAT --> AFNI_CONN
  AFNI_TEMPFILT --> AFNI_CONN
  AFNI_TEMPFILT --> AFNI_STAT
  AFNI_CONN --> AFNI_ROI
  AFNI_MASK --> AFNI_CONN
  AFNI_SM --> AFNI_TEMPFILT
  AFNI_SM --> AFNI_STAT
  AFNI_ROI --> AFNI_CONN
  AFNI_ROI --> AFNI_STAT

  %% AFNI alternative pipeline orderings (skip steps)
  AFNI_DESP --> AFNI_MC
  AFNI_MC --> AFNI_TEMPFILT
  AFNI_MC --> AFNI_MASK
  AFNI_REG --> AFNI_SM
  AFNI_REG --> AFNI_MASK
  AFNI_TEMPFILT --> AFNI_SM
  AFNI_TEMPFILT --> AFNI_MASK

  %% AFNI analysis chains
  AFNI_TEMPFILT --> AFNI_ROI
  AFNI_TEMPFILT --> AFNI_MCMP
  AFNI_STAT --> AFNI_ROI
  AFNI_CONN --> AFNI_MCMP

  %% Cross-library motion correction handoffs
  ANTS_MC --> FSL_ICA
  ANTS_MC --> AFNI_DESP
  ANTS_MC --> FSL_SM
  ANTS_MC --> FSL_STAT
  ANTS_MC --> AFNI_SM
  ANTS_MC --> AFNI_MASK
  FSL_MC --> AFNI_SM
  FSL_MC --> AFNI_MASK
  FSL_MC --> AFNI_STAT

  %% Distortion correction cross-library
  FSL_DC --> AFNI_MC
  FSL_DC --> ANTS_MC
  FSL_DC --> AFNI_DESP
  FSL_DC --> AFNI_ST
  FSL_DC --> AFNI_REG
  FSL_DC --> AFNI_SM

  %% fMRIPrep downstream edges
  FMRIPREP --> FSL_STAT
  FMRIPREP --> FSL_SM
  FMRIPREP --> FSL_ICA
  FMRIPREP --> AFNI_SM
  FMRIPREP --> AFNI_MASK
  FMRIPREP --> AFNI_TEMPFILT
  FMRIPREP --> AFNI_STAT
  FMRIPREP --> AFNI_CONN
  FMRIPREP --> AFNI_ROI
  FMRIPREP --> AFNI_MCMP
  FMRIPREP --> FS_FUNC
  FMRIPREP --> WB_CIFTI
  FMRIPREP --> WB_SURF

  %% Cross-library analysis handoffs
  FSL_ICA --> AFNI_STAT
  FSL_ICA --> AFNI_SM
  FSL_STAT --> AFNI_MCMP
  AFNI_STAT --> FSL_STAT

  %% FreeSurfer / Connectome Workbench
  FS_FUNC --> WB_CIFTI
  WB_CIFTI --> WB_SURF
