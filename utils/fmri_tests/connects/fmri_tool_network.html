<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>fMRI Tool Network</title>
  <style>
    :root {
      --bg: #f7fafc;
      --panel: #ffffff;
      --line: #d0d7de;
      --text: #1f2937;
      --muted: #4b5563;
      --edge: #9ca3af;
      --edge-active: #374151;
      --cluster-fill: rgba(148, 163, 184, 0.08);
      --cluster-stroke: rgba(71, 85, 105, 0.45);
      --focus: #f59e0b;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 14px;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    }

    h1 {
      margin: 0;
      font-size: 20px;
    }

    .meta {
      margin: 4px 0 12px;
      color: var(--muted);
      font-size: 13px;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 280px;
      gap: 12px;
      align-items: start;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 10px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 16px;
      align-items: center;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .controls label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .controls input[type="search"],
    .controls select {
      border: 1px solid var(--line);
      border-radius: 6px;
      padding: 4px 8px;
      min-height: 30px;
      font-size: 13px;
      background: #fff;
      color: var(--text);
    }

    .controls button {
      border: 1px solid var(--line);
      border-radius: 6px;
      padding: 5px 10px;
      background: #fff;
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
    }

    .controls button:hover {
      background: #f3f4f6;
    }

    #network-wrap {
      border: 1px solid var(--line);
      border-radius: 8px;
      overflow: hidden;
      background: #ffffff;
      height: calc(100vh - 180px);
      min-height: 680px;
    }

    svg {
      width: 100%;
      height: 100%;
      display: block;
      user-select: none;
    }

    .cluster-ring {
      fill: var(--cluster-fill);
      stroke: var(--cluster-stroke);
      stroke-dasharray: 5 4;
      stroke-width: 1.2;
    }

    .cluster-label {
      font-size: 11px;
      fill: #334155;
      pointer-events: none;
      text-anchor: middle;
    }

    .edge {
      stroke: var(--edge);
      stroke-width: 1.1;
      stroke-opacity: 0.62;
    }

    .edge.active {
      stroke: var(--edge-active);
      stroke-width: 2;
      stroke-opacity: 0.95;
    }

    .node {
      stroke: #0f172a;
      stroke-width: 0.6;
      cursor: pointer;
      opacity: 0.95;
    }

    .node.dimmed {
      opacity: 0.2;
    }

    .node.focused {
      stroke: var(--focus);
      stroke-width: 2;
    }

    .label {
      font-size: 10px;
      fill: #0f172a;
      paint-order: stroke;
      stroke: #ffffff;
      stroke-width: 2.5;
      stroke-linejoin: round;
      pointer-events: none;
    }

    .label.hidden {
      display: none;
    }

    .legend-title {
      font-weight: 700;
      margin: 0 0 8px;
      font-size: 13px;
    }

    #legend {
      max-height: 44vh;
      overflow: auto;
      border: 1px solid var(--line);
      border-radius: 6px;
      padding: 6px;
      background: #fff;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      margin: 4px 0;
      line-height: 1.3;
    }

    .swatch {
      width: 11px;
      height: 11px;
      border-radius: 3px;
      border: 1px solid rgba(0, 0, 0, 0.2);
      flex: 0 0 auto;
    }

    #details {
      margin-top: 10px;
      padding: 8px;
      border: 1px solid var(--line);
      border-radius: 6px;
      background: #fff;
      min-height: 110px;
      font-size: 12px;
      white-space: pre-line;
      color: #111827;
    }
  </style>
</head>
<body>
  <h1>fMRI Tool Network</h1>
  <p class="meta">
    Interactive directed network view with cluster modes.
    Hover nodes for details and neighborhood highlighting.
  </p>

  <div class="layout">
    <div class="panel">
      <div class="controls">
        <label>
          Cluster mode
          <select id="cluster-mode">
            <option value="subsection">Subsection</option>
            <option value="library">Library</option>
            <option value="community">Connectivity community</option>
            <option value="weak_component">Weak component</option>
          </select>
        </label>
        <label><input id="show-labels" type="checkbox" checked> Show labels</label>
        <label><input id="show-edges" type="checkbox" checked> Show edges</label>
        <label>Search <input id="search" type="search" placeholder="tool name"></label>
        <button id="reset">Reset layout</button>
      </div>

      <div id="network-wrap">
        <svg id="network" viewBox="0 0 1600 980" aria-label="fMRI tool network graph">
          <defs>
            <marker id="arrow" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
              <path d="M 0 0 L 10 5 L 0 10 z" fill="#8b98a8"></path>
            </marker>
            <marker id="arrow-active" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="7" markerHeight="7" orient="auto-start-reverse">
              <path d="M 0 0 L 10 5 L 0 10 z" fill="#334155"></path>
            </marker>
          </defs>
          <g id="cluster-layer"></g>
          <g id="edge-layer"></g>
          <g id="node-layer"></g>
          <g id="label-layer"></g>
        </svg>
      </div>
    </div>

    <aside class="panel">
      <p class="legend-title">Cluster Legend</p>
      <div id="legend"></div>
      <p class="legend-title" style="margin-top: 10px;">Tool Details</p>
      <div id="details">Hover a node to inspect tool metadata and neighbors.</div>
    </aside>
  </div>

  <script>
    const DATA = {"generatedAt": "2026-02-09T17:19:12+00:00", "sources": {"adjacencyJson": "/Users/adamdawood/Documents/Projects/niBuild/utils/fmri_tests/connects/fmri_tool_adjacency_matrix.json", "mappingJson": "/Users/adamdawood/Documents/Projects/niBuild/utils/fmri_tests/connects/fmri_tool_to_subsection_map.json"}, "toolCount": 51, "edgeCount": 135, "nodes": [{"id": "3dANOVA", "index": 0, "library": "AFNI", "subsection": "Statistical Analysis", "subsectionKey": "AFNI / Statistical Analysis", "inDegree": 1, "outDegree": 6, "degree": 7, "cluster": {"subsection": "AFNI / Statistical Analysis", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dANOVA2", "index": 1, "library": "AFNI", "subsection": "Statistical Analysis", "subsectionKey": "AFNI / Statistical Analysis", "inDegree": 1, "outDegree": 6, "degree": 7, "cluster": {"subsection": "AFNI / Statistical Analysis", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dANOVA3", "index": 2, "library": "AFNI", "subsection": "Statistical Analysis", "subsectionKey": "AFNI / Statistical Analysis", "inDegree": 1, "outDegree": 6, "degree": 7, "cluster": {"subsection": "AFNI / Statistical Analysis", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dAutomask", "index": 3, "library": "AFNI", "subsection": "Masking", "subsectionKey": "AFNI / Masking", "inDegree": 2, "outDegree": 10, "degree": 12, "cluster": {"subsection": "AFNI / Masking", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dBandpass", "index": 4, "library": "AFNI", "subsection": "Denoising", "subsectionKey": "AFNI / Denoising", "inDegree": 1, "outDegree": 1, "degree": 2, "cluster": {"subsection": "AFNI / Denoising", "library": "AFNI", "weak_component": "component_01", "community": "community_03"}}, {"id": "3dBlurToFWHM", "index": 5, "library": "AFNI", "subsection": "Smoothing", "subsectionKey": "AFNI / Smoothing", "inDegree": 1, "outDegree": 1, "degree": 2, "cluster": {"subsection": "AFNI / Smoothing", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dClustSim", "index": 6, "library": "AFNI", "subsection": "Multiple Comparisons", "subsectionKey": "AFNI / Multiple Comparisons", "inDegree": 10, "outDegree": 0, "degree": 10, "cluster": {"subsection": "AFNI / Multiple Comparisons", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dDeconvolve", "index": 7, "library": "AFNI", "subsection": "Statistical Analysis", "subsectionKey": "AFNI / Statistical Analysis", "inDegree": 1, "outDegree": 6, "degree": 7, "cluster": {"subsection": "AFNI / Statistical Analysis", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dDespike", "index": 8, "library": "AFNI", "subsection": "Denoising", "subsectionKey": "AFNI / Denoising", "inDegree": 1, "outDegree": 1, "degree": 2, "cluster": {"subsection": "AFNI / Denoising", "library": "AFNI", "weak_component": "component_01", "community": "community_03"}}, {"id": "3dFWHMx", "index": 9, "library": "AFNI", "subsection": "Multiple Comparisons", "subsectionKey": "AFNI / Multiple Comparisons", "inDegree": 10, "outDegree": 0, "degree": 10, "cluster": {"subsection": "AFNI / Multiple Comparisons", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dLME", "index": 10, "library": "AFNI", "subsection": "Statistical Analysis", "subsectionKey": "AFNI / Statistical Analysis", "inDegree": 1, "outDegree": 6, "degree": 7, "cluster": {"subsection": "AFNI / Statistical Analysis", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dLMEr", "index": 11, "library": "AFNI", "subsection": "Statistical Analysis", "subsectionKey": "AFNI / Statistical Analysis", "inDegree": 1, "outDegree": 6, "degree": 7, "cluster": {"subsection": "AFNI / Statistical Analysis", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dMEMA", "index": 12, "library": "AFNI", "subsection": "Statistical Analysis", "subsectionKey": "AFNI / Statistical Analysis", "inDegree": 1, "outDegree": 6, "degree": 7, "cluster": {"subsection": "AFNI / Statistical Analysis", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dMVM", "index": 13, "library": "AFNI", "subsection": "Statistical Analysis", "subsectionKey": "AFNI / Statistical Analysis", "inDegree": 1, "outDegree": 6, "degree": 7, "cluster": {"subsection": "AFNI / Statistical Analysis", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dNetCorr", "index": 14, "library": "AFNI", "subsection": "Connectivity", "subsectionKey": "AFNI / Connectivity", "inDegree": 11, "outDegree": 2, "degree": 13, "cluster": {"subsection": "AFNI / Connectivity", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dREMLfit", "index": 15, "library": "AFNI", "subsection": "Statistical Analysis", "subsectionKey": "AFNI / Statistical Analysis", "inDegree": 1, "outDegree": 6, "degree": 7, "cluster": {"subsection": "AFNI / Statistical Analysis", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dROIstats", "index": 16, "library": "AFNI", "subsection": "ROI Analysis", "subsectionKey": "AFNI / ROI Analysis", "inDegree": 4, "outDegree": 0, "degree": 4, "cluster": {"subsection": "AFNI / ROI Analysis", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dRSFC", "index": 17, "library": "AFNI", "subsection": "Connectivity", "subsectionKey": "AFNI / Connectivity", "inDegree": 11, "outDegree": 2, "degree": 13, "cluster": {"subsection": "AFNI / Connectivity", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dTcorr1D", "index": 18, "library": "AFNI", "subsection": "Connectivity", "subsectionKey": "AFNI / Connectivity", "inDegree": 11, "outDegree": 2, "degree": 13, "cluster": {"subsection": "AFNI / Connectivity", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dTcorrMap", "index": 19, "library": "AFNI", "subsection": "Connectivity", "subsectionKey": "AFNI / Connectivity", "inDegree": 11, "outDegree": 2, "degree": 13, "cluster": {"subsection": "AFNI / Connectivity", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dTshift", "index": 20, "library": "AFNI", "subsection": "Slice Timing", "subsectionKey": "AFNI / Slice Timing", "inDegree": 2, "outDegree": 1, "degree": 3, "cluster": {"subsection": "AFNI / Slice Timing", "library": "AFNI", "weak_component": "component_01", "community": "community_03"}}, {"id": "3dmaskave", "index": 21, "library": "AFNI", "subsection": "ROI Analysis", "subsectionKey": "AFNI / ROI Analysis", "inDegree": 4, "outDegree": 0, "degree": 4, "cluster": {"subsection": "AFNI / ROI Analysis", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dmerge", "index": 22, "library": "AFNI", "subsection": "Smoothing", "subsectionKey": "AFNI / Smoothing", "inDegree": 1, "outDegree": 1, "degree": 2, "cluster": {"subsection": "AFNI / Smoothing", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dttest++", "index": 23, "library": "AFNI", "subsection": "Statistical Analysis", "subsectionKey": "AFNI / Statistical Analysis", "inDegree": 1, "outDegree": 6, "degree": 7, "cluster": {"subsection": "AFNI / Statistical Analysis", "library": "AFNI", "weak_component": "component_01", "community": "community_01"}}, {"id": "3dvolreg", "index": 24, "library": "AFNI", "subsection": "Motion Correction", "subsectionKey": "AFNI / Motion Correction", "inDegree": 2, "outDegree": 2, "degree": 4, "cluster": {"subsection": "AFNI / Motion Correction", "library": "AFNI", "weak_component": "component_01", "community": "community_03"}}, {"id": "align_epi_anat", "index": 25, "library": "AFNI", "subsection": "Registration", "subsectionKey": "AFNI / Registration", "inDegree": 1, "outDegree": 1, "degree": 2, "cluster": {"subsection": "AFNI / Registration", "library": "AFNI", "weak_component": "component_01", "community": "community_03"}}, {"id": "antsMotionCorr", "index": 26, "library": "ANTs", "subsection": "Motion Correction", "subsectionKey": "ANTs / Motion Correction", "inDegree": 1, "outDegree": 4, "degree": 5, "cluster": {"subsection": "ANTs / Motion Correction", "library": "ANTs", "weak_component": "component_01", "community": "community_03"}}, {"id": "applytopup", "index": 27, "library": "FSL", "subsection": "Distortion Correction", "subsectionKey": "FSL / Distortion Correction", "inDegree": 0, "outDegree": 1, "degree": 1, "cluster": {"subsection": "FSL / Distortion Correction", "library": "FSL", "weak_component": "component_01", "community": "community_04"}}, {"id": "bbregister", "index": 28, "library": "FreeSurfer", "subsection": "Functional Analysis", "subsectionKey": "FreeSurfer / Functional Analysis", "inDegree": 1, "outDegree": 2, "degree": 3, "cluster": {"subsection": "FreeSurfer / Functional Analysis", "library": "FreeSurfer", "weak_component": "component_01", "community": "community_02"}}, {"id": "dual_regression", "index": 29, "library": "FSL", "subsection": "ICA/Denoising", "subsectionKey": "FSL / ICA/Denoising", "inDegree": 2, "outDegree": 1, "degree": 3, "cluster": {"subsection": "FSL / ICA/Denoising", "library": "FSL", "weak_component": "component_01", "community": "community_03"}}, {"id": "film_gls", "index": 30, "library": "FSL", "subsection": "Statistical Analysis", "subsectionKey": "FSL / Statistical Analysis", "inDegree": 2, "outDegree": 0, "degree": 2, "cluster": {"subsection": "FSL / Statistical Analysis", "library": "FSL", "weak_component": "component_01", "community": "community_02"}}, {"id": "flameo", "index": 31, "library": "FSL", "subsection": "Statistical Analysis", "subsectionKey": "FSL / Statistical Analysis", "inDegree": 2, "outDegree": 0, "degree": 2, "cluster": {"subsection": "FSL / Statistical Analysis", "library": "FSL", "weak_component": "component_01", "community": "community_02"}}, {"id": "fmriprep", "index": 32, "library": "fMRIPrep", "subsection": "Pipeline", "subsectionKey": "fMRIPrep / Pipeline", "inDegree": 1, "outDegree": 14, "degree": 15, "cluster": {"subsection": "fMRIPrep / Pipeline", "library": "fMRIPrep", "weak_component": "component_01", "community": "community_02"}}, {"id": "fsl_prepare_fieldmap", "index": 33, "library": "FSL", "subsection": "Distortion Correction", "subsectionKey": "FSL / Distortion Correction", "inDegree": 0, "outDegree": 1, "degree": 1, "cluster": {"subsection": "FSL / Distortion Correction", "library": "FSL", "weak_component": "component_01", "community": "community_04"}}, {"id": "fugue", "index": 34, "library": "FSL", "subsection": "Distortion Correction", "subsectionKey": "FSL / Distortion Correction", "inDegree": 0, "outDegree": 1, "degree": 1, "cluster": {"subsection": "FSL / Distortion Correction", "library": "FSL", "weak_component": "component_01", "community": "community_04"}}, {"id": "mcflirt", "index": 35, "library": "FSL", "subsection": "Motion Correction", "subsectionKey": "FSL / Motion Correction", "inDegree": 6, "outDegree": 1, "degree": 7, "cluster": {"subsection": "FSL / Motion Correction", "library": "FSL", "weak_component": "component_01", "community": "community_04"}}, {"id": "melodic", "index": 36, "library": "FSL", "subsection": "ICA/Denoising", "subsectionKey": "FSL / ICA/Denoising", "inDegree": 2, "outDegree": 1, "degree": 3, "cluster": {"subsection": "FSL / ICA/Denoising", "library": "FSL", "weak_component": "component_01", "community": "community_03"}}, {"id": "mri_glmfit", "index": 37, "library": "FreeSurfer", "subsection": "Functional Analysis", "subsectionKey": "FreeSurfer / Functional Analysis", "inDegree": 1, "outDegree": 2, "degree": 3, "cluster": {"subsection": "FreeSurfer / Functional Analysis", "library": "FreeSurfer", "weak_component": "component_01", "community": "community_02"}}, {"id": "mri_surf2vol", "index": 38, "library": "FreeSurfer", "subsection": "Functional Analysis", "subsectionKey": "FreeSurfer / Functional Analysis", "inDegree": 1, "outDegree": 2, "degree": 3, "cluster": {"subsection": "FreeSurfer / Functional Analysis", "library": "FreeSurfer", "weak_component": "component_01", "community": "community_02"}}, {"id": "mri_vol2surf", "index": 39, "library": "FreeSurfer", "subsection": "Functional Analysis", "subsectionKey": "FreeSurfer / Functional Analysis", "inDegree": 1, "outDegree": 2, "degree": 3, "cluster": {"subsection": "FreeSurfer / Functional Analysis", "library": "FreeSurfer", "weak_component": "component_01", "community": "community_02"}}, {"id": "mriqc", "index": 40, "library": "MRIQC", "subsection": "Pipeline", "subsectionKey": "MRIQC / Pipeline", "inDegree": 0, "outDegree": 4, "degree": 4, "cluster": {"subsection": "MRIQC / Pipeline", "library": "MRIQC", "weak_component": "component_01", "community": "community_03"}}, {"id": "mris_preproc", "index": 41, "library": "FreeSurfer", "subsection": "Functional Analysis", "subsectionKey": "FreeSurfer / Functional Analysis", "inDegree": 1, "outDegree": 2, "degree": 3, "cluster": {"subsection": "FreeSurfer / Functional Analysis", "library": "FreeSurfer", "weak_component": "component_01", "community": "community_02"}}, {"id": "prelude", "index": 42, "library": "FSL", "subsection": "Distortion Correction", "subsectionKey": "FSL / Distortion Correction", "inDegree": 0, "outDegree": 1, "degree": 1, "cluster": {"subsection": "FSL / Distortion Correction", "library": "FSL", "weak_component": "component_01", "community": "community_04"}}, {"id": "randomise", "index": 43, "library": "FSL", "subsection": "Statistical Analysis", "subsectionKey": "FSL / Statistical Analysis", "inDegree": 2, "outDegree": 0, "degree": 2, "cluster": {"subsection": "FSL / Statistical Analysis", "library": "FSL", "weak_component": "component_01", "community": "community_02"}}, {"id": "slicetimer", "index": 44, "library": "FSL", "subsection": "Slice Timing", "subsectionKey": "FSL / Slice Timing", "inDegree": 1, "outDegree": 2, "degree": 3, "cluster": {"subsection": "FSL / Slice Timing", "library": "FSL", "weak_component": "component_01", "community": "community_03"}}, {"id": "susan", "index": 45, "library": "FSL", "subsection": "Smoothing", "subsectionKey": "FSL / Smoothing", "inDegree": 2, "outDegree": 3, "degree": 5, "cluster": {"subsection": "FSL / Smoothing", "library": "FSL", "weak_component": "component_01", "community": "community_02"}}, {"id": "topup", "index": 46, "library": "FSL", "subsection": "Distortion Correction", "subsectionKey": "FSL / Distortion Correction", "inDegree": 0, "outDegree": 1, "degree": 1, "cluster": {"subsection": "FSL / Distortion Correction", "library": "FSL", "weak_component": "component_01", "community": "community_04"}}, {"id": "wb_command_cifti_create_dense_timeseries", "index": 47, "library": "Connectome Workbench", "subsection": "CIFTI Operations", "subsectionKey": "Connectome Workbench / CIFTI Operations", "inDegree": 6, "outDegree": 2, "degree": 8, "cluster": {"subsection": "Connectome Workbench / CIFTI Operations", "library": "Connectome Workbench", "weak_component": "component_01", "community": "community_02"}}, {"id": "wb_command_cifti_separate", "index": 48, "library": "Connectome Workbench", "subsection": "CIFTI Operations", "subsectionKey": "Connectome Workbench / CIFTI Operations", "inDegree": 6, "outDegree": 2, "degree": 8, "cluster": {"subsection": "Connectome Workbench / CIFTI Operations", "library": "Connectome Workbench", "weak_component": "component_01", "community": "community_02"}}, {"id": "wb_command_cifti_smoothing", "index": 49, "library": "Connectome Workbench", "subsection": "Surface Smoothing", "subsectionKey": "Connectome Workbench / Surface Smoothing", "inDegree": 2, "outDegree": 0, "degree": 2, "cluster": {"subsection": "Connectome Workbench / Surface Smoothing", "library": "Connectome Workbench", "weak_component": "component_01", "community": "community_02"}}, {"id": "wb_command_metric_smoothing", "index": 50, "library": "Connectome Workbench", "subsection": "Surface Smoothing", "subsectionKey": "Connectome Workbench / Surface Smoothing", "inDegree": 2, "outDegree": 0, "degree": 2, "cluster": {"subsection": "Connectome Workbench / Surface Smoothing", "library": "Connectome Workbench", "weak_component": "component_01", "community": "community_02"}}], "edges": [{"source": 0, "target": 6}, {"source": 0, "target": 9}, {"source": 0, "target": 14}, {"source": 0, "target": 17}, {"source": 0, "target": 18}, {"source": 0, "target": 19}, {"source": 1, "target": 6}, {"source": 1, "target": 9}, {"source": 1, "target": 14}, {"source": 1, "target": 17}, {"source": 1, "target": 18}, {"source": 1, "target": 19}, {"source": 2, "target": 6}, {"source": 2, "target": 9}, {"source": 2, "target": 14}, {"source": 2, "target": 17}, {"source": 2, "target": 18}, {"source": 2, "target": 19}, {"source": 3, "target": 0}, {"source": 3, "target": 1}, {"source": 3, "target": 2}, {"source": 3, "target": 7}, {"source": 3, "target": 10}, {"source": 3, "target": 11}, {"source": 3, "target": 12}, {"source": 3, "target": 13}, {"source": 3, "target": 15}, {"source": 3, "target": 23}, {"source": 4, "target": 20}, {"source": 5, "target": 3}, {"source": 7, "target": 6}, {"source": 7, "target": 9}, {"source": 7, "target": 14}, {"source": 7, "target": 17}, {"source": 7, "target": 18}, {"source": 7, "target": 19}, {"source": 8, "target": 20}, {"source": 10, "target": 6}, {"source": 10, "target": 9}, {"source": 10, "target": 14}, {"source": 10, "target": 17}, {"source": 10, "target": 18}, {"source": 10, "target": 19}, {"source": 11, "target": 6}, {"source": 11, "target": 9}, {"source": 11, "target": 14}, {"source": 11, "target": 17}, {"source": 11, "target": 18}, {"source": 11, "target": 19}, {"source": 12, "target": 6}, {"source": 12, "target": 9}, {"source": 12, "target": 14}, {"source": 12, "target": 17}, {"source": 12, "target": 18}, {"source": 12, "target": 19}, {"source": 13, "target": 6}, {"source": 13, "target": 9}, {"source": 13, "target": 14}, {"source": 13, "target": 17}, {"source": 13, "target": 18}, {"source": 13, "target": 19}, {"source": 14, "target": 16}, {"source": 14, "target": 21}, {"source": 15, "target": 6}, {"source": 15, "target": 9}, {"source": 15, "target": 14}, {"source": 15, "target": 17}, {"source": 15, "target": 18}, {"source": 15, "target": 19}, {"source": 17, "target": 16}, {"source": 17, "target": 21}, {"source": 18, "target": 16}, {"source": 18, "target": 21}, {"source": 19, "target": 16}, {"source": 19, "target": 21}, {"source": 20, "target": 25}, {"source": 22, "target": 3}, {"source": 23, "target": 6}, {"source": 23, "target": 9}, {"source": 23, "target": 14}, {"source": 23, "target": 17}, {"source": 23, "target": 18}, {"source": 23, "target": 19}, {"source": 24, "target": 5}, {"source": 24, "target": 22}, {"source": 25, "target": 24}, {"source": 26, "target": 4}, {"source": 26, "target": 8}, {"source": 26, "target": 29}, {"source": 26, "target": 36}, {"source": 27, "target": 35}, {"source": 28, "target": 47}, {"source": 28, "target": 48}, {"source": 29, "target": 45}, {"source": 32, "target": 14}, {"source": 32, "target": 17}, {"source": 32, "target": 18}, {"source": 32, "target": 19}, {"source": 32, "target": 28}, {"source": 32, "target": 30}, {"source": 32, "target": 31}, {"source": 32, "target": 37}, {"source": 32, "target": 38}, {"source": 32, "target": 39}, {"source": 32, "target": 41}, {"source": 32, "target": 43}, {"source": 32, "target": 47}, {"source": 32, "target": 48}, {"source": 33, "target": 35}, {"source": 34, "target": 35}, {"source": 35, "target": 44}, {"source": 36, "target": 45}, {"source": 37, "target": 47}, {"source": 37, "target": 48}, {"source": 38, "target": 47}, {"source": 38, "target": 48}, {"source": 39, "target": 47}, {"source": 39, "target": 48}, {"source": 40, "target": 24}, {"source": 40, "target": 26}, {"source": 40, "target": 32}, {"source": 40, "target": 35}, {"source": 41, "target": 47}, {"source": 41, "target": 48}, {"source": 42, "target": 35}, {"source": 44, "target": 29}, {"source": 44, "target": 36}, {"source": 45, "target": 30}, {"source": 45, "target": 31}, {"source": 45, "target": 43}, {"source": 46, "target": 35}, {"source": 47, "target": 49}, {"source": 47, "target": 50}, {"source": 48, "target": 49}, {"source": 48, "target": 50}], "clusterings": {"subsection": {"label": "Subsection", "groupCount": 22, "groups": [{"name": "AFNI / Statistical Analysis", "size": 10, "tools": ["3dANOVA", "3dANOVA2", "3dANOVA3", "3dDeconvolve", "3dLME", "3dLMEr", "3dMEMA", "3dMVM", "3dREMLfit", "3dttest++"]}, {"name": "FreeSurfer / Functional Analysis", "size": 5, "tools": ["bbregister", "mri_glmfit", "mri_surf2vol", "mri_vol2surf", "mris_preproc"]}, {"name": "FSL / Distortion Correction", "size": 5, "tools": ["applytopup", "fsl_prepare_fieldmap", "fugue", "prelude", "topup"]}, {"name": "AFNI / Connectivity", "size": 4, "tools": ["3dNetCorr", "3dRSFC", "3dTcorr1D", "3dTcorrMap"]}, {"name": "FSL / Statistical Analysis", "size": 3, "tools": ["film_gls", "flameo", "randomise"]}, {"name": "AFNI / Denoising", "size": 2, "tools": ["3dBandpass", "3dDespike"]}, {"name": "AFNI / Multiple Comparisons", "size": 2, "tools": ["3dClustSim", "3dFWHMx"]}, {"name": "AFNI / ROI Analysis", "size": 2, "tools": ["3dROIstats", "3dmaskave"]}, {"name": "AFNI / Smoothing", "size": 2, "tools": ["3dBlurToFWHM", "3dmerge"]}, {"name": "Connectome Workbench / CIFTI Operations", "size": 2, "tools": ["wb_command_cifti_create_dense_timeseries", "wb_command_cifti_separate"]}, {"name": "Connectome Workbench / Surface Smoothing", "size": 2, "tools": ["wb_command_cifti_smoothing", "wb_command_metric_smoothing"]}, {"name": "FSL / ICA/Denoising", "size": 2, "tools": ["dual_regression", "melodic"]}, {"name": "AFNI / Masking", "size": 1, "tools": ["3dAutomask"]}, {"name": "AFNI / Motion Correction", "size": 1, "tools": ["3dvolreg"]}, {"name": "AFNI / Registration", "size": 1, "tools": ["align_epi_anat"]}, {"name": "AFNI / Slice Timing", "size": 1, "tools": ["3dTshift"]}, {"name": "ANTs / Motion Correction", "size": 1, "tools": ["antsMotionCorr"]}, {"name": "fMRIPrep / Pipeline", "size": 1, "tools": ["fmriprep"]}, {"name": "FSL / Motion Correction", "size": 1, "tools": ["mcflirt"]}, {"name": "FSL / Slice Timing", "size": 1, "tools": ["slicetimer"]}, {"name": "FSL / Smoothing", "size": 1, "tools": ["susan"]}, {"name": "MRIQC / Pipeline", "size": 1, "tools": ["mriqc"]}]}, "library": {"label": "Library", "groupCount": 7, "groups": [{"name": "AFNI", "size": 26, "tools": ["3dANOVA", "3dANOVA2", "3dANOVA3", "3dAutomask", "3dBandpass", "3dBlurToFWHM", "3dClustSim", "3dDeconvolve", "3dDespike", "3dFWHMx", "3dLME", "3dLMEr", "3dMEMA", "3dMVM", "3dNetCorr", "3dREMLfit", "3dROIstats", "3dRSFC", "3dTcorr1D", "3dTcorrMap", "3dTshift", "3dmaskave", "3dmerge", "3dttest++", "3dvolreg", "align_epi_anat"]}, {"name": "FSL", "size": 13, "tools": ["applytopup", "dual_regression", "film_gls", "flameo", "fsl_prepare_fieldmap", "fugue", "mcflirt", "melodic", "prelude", "randomise", "slicetimer", "susan", "topup"]}, {"name": "FreeSurfer", "size": 5, "tools": ["bbregister", "mri_glmfit", "mri_surf2vol", "mri_vol2surf", "mris_preproc"]}, {"name": "Connectome Workbench", "size": 4, "tools": ["wb_command_cifti_create_dense_timeseries", "wb_command_cifti_separate", "wb_command_cifti_smoothing", "wb_command_metric_smoothing"]}, {"name": "ANTs", "size": 1, "tools": ["antsMotionCorr"]}, {"name": "fMRIPrep", "size": 1, "tools": ["fmriprep"]}, {"name": "MRIQC", "size": 1, "tools": ["mriqc"]}]}, "weak_component": {"label": "Weakly Connected Component", "groupCount": 1, "groups": [{"name": "component_01", "size": 51, "tools": ["3dANOVA", "3dANOVA2", "3dANOVA3", "3dAutomask", "3dBandpass", "3dBlurToFWHM", "3dClustSim", "3dDeconvolve", "3dDespike", "3dFWHMx", "3dLME", "3dLMEr", "3dMEMA", "3dMVM", "3dNetCorr", "3dREMLfit", "3dROIstats", "3dRSFC", "3dTcorr1D", "3dTcorrMap", "3dTshift", "3dmaskave", "3dmerge", "3dttest++", "3dvolreg", "align_epi_anat", "antsMotionCorr", "applytopup", "bbregister", "dual_regression", "film_gls", "flameo", "fmriprep", "fsl_prepare_fieldmap", "fugue", "mcflirt", "melodic", "mri_glmfit", "mri_surf2vol", "mri_vol2surf", "mriqc", "mris_preproc", "prelude", "randomise", "slicetimer", "susan", "topup", "wb_command_cifti_create_dense_timeseries", "wb_command_cifti_separate", "wb_command_cifti_smoothing", "wb_command_metric_smoothing"]}]}, "community": {"label": "Connectivity Community (Label Propagation)", "groupCount": 4, "groups": [{"name": "community_01", "size": 21, "tools": ["3dANOVA", "3dANOVA2", "3dANOVA3", "3dAutomask", "3dBlurToFWHM", "3dClustSim", "3dDeconvolve", "3dFWHMx", "3dLME", "3dLMEr", "3dMEMA", "3dMVM", "3dNetCorr", "3dREMLfit", "3dROIstats", "3dRSFC", "3dTcorr1D", "3dTcorrMap", "3dmaskave", "3dmerge", "3dttest++"]}, {"name": "community_02", "size": 14, "tools": ["bbregister", "film_gls", "flameo", "fmriprep", "mri_glmfit", "mri_surf2vol", "mri_vol2surf", "mris_preproc", "randomise", "susan", "wb_command_cifti_create_dense_timeseries", "wb_command_cifti_separate", "wb_command_cifti_smoothing", "wb_command_metric_smoothing"]}, {"name": "community_03", "size": 10, "tools": ["3dBandpass", "3dDespike", "3dTshift", "3dvolreg", "align_epi_anat", "antsMotionCorr", "dual_regression", "melodic", "mriqc", "slicetimer"]}, {"name": "community_04", "size": 6, "tools": ["applytopup", "fsl_prepare_fieldmap", "fugue", "mcflirt", "prelude", "topup"]}]}}};

    const width = 1600;
    const height = 980;
    const basePadding = 70;
    const nodes = DATA.nodes.map((node) => ({
      ...node,
      x: width / 2,
      y: height / 2,
      vx: 0,
      vy: 0
    }));
    const edges = DATA.edges;

    const indexById = new Map(nodes.map((node, idx) => [node.id, idx]));
    const outNeighbors = Array.from({ length: nodes.length }, () => new Set());
    const inNeighbors = Array.from({ length: nodes.length }, () => new Set());
    edges.forEach((edge) => {
      outNeighbors[edge.source].add(edge.target);
      inNeighbors[edge.target].add(edge.source);
    });

    const state = {
      clusterMode: "subsection",
      showLabels: true,
      showEdges: true,
      search: "",
      hovered: null
    };

    const svg = document.getElementById("network");
    const clusterLayer = document.getElementById("cluster-layer");
    const edgeLayer = document.getElementById("edge-layer");
    const nodeLayer = document.getElementById("node-layer");
    const labelLayer = document.getElementById("label-layer");
    const legendEl = document.getElementById("legend");
    const detailsEl = document.getElementById("details");
    const clusterModeEl = document.getElementById("cluster-mode");
    const showLabelsEl = document.getElementById("show-labels");
    const showEdgesEl = document.getElementById("show-edges");
    const searchEl = document.getElementById("search");
    const resetEl = document.getElementById("reset");

    function colorForCluster(clusterIndex, total) {
      const hue = ((clusterIndex * 360) / Math.max(1, total) + 13) % 360;
      return `hsl(${hue} 62% 52%)`;
    }

    function hashString(value) {
      let hash = 2166136261;
      for (let i = 0; i < value.length; i += 1) {
        hash ^= value.charCodeAt(i);
        hash = Math.imul(hash, 16777619);
      }
      return Math.abs(hash >>> 0);
    }

    function jitterForNode(nodeId, axisSalt) {
      const seed = hashString(`${nodeId}:${axisSalt}`);
      return (seed % 1000) / 1000;
    }

    function nodeRadius(node) {
      return 5 + Math.min(8, Math.sqrt(node.degree || 0));
    }

    function getGroups(mode) {
      return DATA.clusterings[mode]?.groups || [];
    }

    function buildClusterColorMap(mode) {
      const groups = getGroups(mode);
      const map = new Map();
      groups.forEach((group, idx) => {
        map.set(group.name, colorForCluster(idx, groups.length));
      });
      return map;
    }

    function buildClusterCenters(mode) {
      const groups = getGroups(mode);
      const count = Math.max(1, groups.length);
      const cols = Math.ceil(Math.sqrt(count));
      const rows = Math.ceil(count / cols);
      const xStep = (width - basePadding * 2) / Math.max(1, cols - 1);
      const yStep = (height - basePadding * 2) / Math.max(1, rows - 1);

      const centers = new Map();
      groups.forEach((group, idx) => {
        const col = cols === 1 ? 0 : idx % cols;
        const row = cols === 1 ? idx : Math.floor(idx / cols);
        const x = cols === 1 ? width / 2 : basePadding + col * xStep;
        const y = rows === 1 ? height / 2 : basePadding + row * yStep;
        const radius = Math.max(70, 34 + Math.sqrt(group.size || 1) * 24);
        centers.set(group.name, { x, y, radius, name: group.name, size: group.size || 0 });
      });
      return centers;
    }

    function resetNodePositions() {
      const centers = buildClusterCenters(state.clusterMode);
      nodes.forEach((node) => {
        const cluster = node.cluster[state.clusterMode];
        const center = centers.get(cluster) || { x: width / 2, y: height / 2, radius: 120 };
        const angle = jitterForNode(node.id, "angle") * Math.PI * 2;
        const radius = (0.12 + 0.8 * jitterForNode(node.id, "radius")) * center.radius;
        node.x = center.x + Math.cos(angle) * radius;
        node.y = center.y + Math.sin(angle) * radius;
        node.vx = 0;
        node.vy = 0;
      });
    }

    function buildEdgeElements() {
      edgeLayer.innerHTML = "";
      return edges.map((edge) => {
        const el = document.createElementNS("http://www.w3.org/2000/svg", "line");
        el.setAttribute("class", "edge");
        el.setAttribute("marker-end", "url(#arrow)");
        edgeLayer.appendChild(el);
        return el;
      });
    }

    function buildNodeElements() {
      nodeLayer.innerHTML = "";
      labelLayer.innerHTML = "";

      const nodeEls = [];
      const labelEls = [];
      nodes.forEach((node, idx) => {
        const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        circle.setAttribute("class", "node");
        circle.setAttribute("r", String(nodeRadius(node)));
        circle.dataset.index = String(idx);
        circle.addEventListener("mouseenter", () => {
          state.hovered = idx;
          updateDetailsPanel(idx);
        });
        circle.addEventListener("mouseleave", () => {
          state.hovered = null;
          updateDetailsPanel(null);
        });
        nodeLayer.appendChild(circle);
        nodeEls.push(circle);

        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("class", "label");
        label.textContent = node.id;
        labelLayer.appendChild(label);
        labelEls.push(label);
      });

      return { nodeEls, labelEls };
    }

    function drawClusterLayer(mode, clusterColors) {
      const centers = buildClusterCenters(mode);
      clusterLayer.innerHTML = "";
      centers.forEach((center, name) => {
        const ring = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        ring.setAttribute("class", "cluster-ring");
        ring.setAttribute("cx", String(center.x));
        ring.setAttribute("cy", String(center.y));
        ring.setAttribute("r", String(center.radius));
        const color = clusterColors.get(name) || "#64748b";
        ring.setAttribute("stroke", color);
        clusterLayer.appendChild(ring);

        const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
        label.setAttribute("class", "cluster-label");
        label.setAttribute("x", String(center.x));
        label.setAttribute("y", String(center.y - center.radius - 10));
        label.textContent = `${name} (${center.size})`;
        clusterLayer.appendChild(label);
      });
    }

    function updateLegend(mode, clusterColors) {
      const groups = getGroups(mode);
      const label = DATA.clusterings[mode]?.label || mode;
      const items = groups.map((group) => {
        const color = clusterColors.get(group.name) || "#64748b";
        const safeName = group.name
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");
        return `<div class="legend-item"><span class="swatch" style="background:${color}"></span><span>${safeName} (${group.size})</span></div>`;
      }).join("");
      legendEl.innerHTML = `<div style="font-size:12px;color:#4b5563;margin-bottom:6px;">${label}</div>${items || "<div class='legend-item'>No groups</div>"}`;
    }

    function updateDetailsPanel(nodeIndex) {
      if (nodeIndex === null || nodeIndex === undefined) {
        detailsEl.textContent = "Hover a node to inspect tool metadata and neighbors.";
        return;
      }
      const node = nodes[nodeIndex];
      const outgoing = Array.from(outNeighbors[nodeIndex]).map((idx) => nodes[idx].id).sort();
      const incoming = Array.from(inNeighbors[nodeIndex]).map((idx) => nodes[idx].id).sort();
      detailsEl.textContent = [
        `Tool: ${node.id}`,
        `Library: ${node.library}`,
        `Subsection: ${node.subsectionKey}`,
        `Out-degree: ${node.outDegree}`,
        `In-degree: ${node.inDegree}`,
        `Cluster (${DATA.clusterings[state.clusterMode]?.label || state.clusterMode}): ${node.cluster[state.clusterMode]}`,
        "",
        `Outgoing (${outgoing.length}): ${outgoing.join(", ") || "none"}`,
        "",
        `Incoming (${incoming.length}): ${incoming.join(", ") || "none"}`
      ].join("\n");
    }

    function applyForces(clusterCenters) {
      const repulsion = 2400;
      const springK = 0.028;
      const desiredEdgeLength = 90;
      const pullToCluster = 0.016;
      const centerPull = 0.0014;

      for (let i = 0; i < nodes.length; i += 1) {
        for (let j = i + 1; j < nodes.length; j += 1) {
          const a = nodes[i];
          const b = nodes[j];
          const dx = b.x - a.x;
          const dy = b.y - a.y;
          const dist2 = dx * dx + dy * dy + 0.01;
          const dist = Math.sqrt(dist2);
          const force = repulsion / dist2;
          const fx = (force * dx) / dist;
          const fy = (force * dy) / dist;
          a.vx -= fx;
          a.vy -= fy;
          b.vx += fx;
          b.vy += fy;
        }
      }

      edges.forEach((edge) => {
        const src = nodes[edge.source];
        const dst = nodes[edge.target];
        const dx = dst.x - src.x;
        const dy = dst.y - src.y;
        const dist = Math.max(0.01, Math.sqrt(dx * dx + dy * dy));
        const displacement = dist - desiredEdgeLength;
        const force = springK * displacement;
        const fx = (force * dx) / dist;
        const fy = (force * dy) / dist;
        src.vx += fx;
        src.vy += fy;
        dst.vx -= fx;
        dst.vy -= fy;
      });

      nodes.forEach((node) => {
        const cluster = node.cluster[state.clusterMode];
        const center = clusterCenters.get(cluster) || { x: width / 2, y: height / 2 };
        node.vx += (center.x - node.x) * pullToCluster;
        node.vy += (center.y - node.y) * pullToCluster;
        node.vx += (width / 2 - node.x) * centerPull;
        node.vy += (height / 2 - node.y) * centerPull;

        node.vx *= 0.84;
        node.vy *= 0.84;

        const maxSpeed = 10;
        node.vx = Math.max(-maxSpeed, Math.min(maxSpeed, node.vx));
        node.vy = Math.max(-maxSpeed, Math.min(maxSpeed, node.vy));

        node.x = Math.max(18, Math.min(width - 18, node.x + node.vx));
        node.y = Math.max(18, Math.min(height - 18, node.y + node.vy));
      });
    }

    function buildSearchSet() {
      const needle = state.search.trim().toLowerCase();
      if (!needle) {
        return new Set();
      }
      return new Set(
        nodes
          .map((node, idx) => ({ node, idx }))
          .filter(({ node }) => node.id.toLowerCase().includes(needle))
          .map(({ idx }) => idx)
      );
    }

    function drawFrame(nodeEls, labelEls, edgeEls, clusterColors, clusterCenters) {
      const searchHits = buildSearchSet();
      const hovered = state.hovered;
      const activeNeighbors = new Set();
      if (hovered !== null && hovered !== undefined) {
        activeNeighbors.add(hovered);
        outNeighbors[hovered].forEach((idx) => activeNeighbors.add(idx));
        inNeighbors[hovered].forEach((idx) => activeNeighbors.add(idx));
      }

      edgeEls.forEach((el, idx) => {
        const edge = edges[idx];
        const src = nodes[edge.source];
        const dst = nodes[edge.target];
        const dx = dst.x - src.x;
        const dy = dst.y - src.y;
        const dist = Math.max(0.001, Math.sqrt(dx * dx + dy * dy));
        const srcPad = nodeRadius(src) + 1;
        const dstPad = nodeRadius(dst) + 3;
        const x1 = src.x + (dx / dist) * srcPad;
        const y1 = src.y + (dy / dist) * srcPad;
        const x2 = dst.x - (dx / dist) * dstPad;
        const y2 = dst.y - (dy / dist) * dstPad;

        el.setAttribute("x1", String(x1));
        el.setAttribute("y1", String(y1));
        el.setAttribute("x2", String(x2));
        el.setAttribute("y2", String(y2));

        const isActive = hovered !== null && hovered !== undefined &&
          (edge.source === hovered || edge.target === hovered);
        el.setAttribute("class", isActive ? "edge active" : "edge");
        el.setAttribute("marker-end", isActive ? "url(#arrow-active)" : "url(#arrow)");
        el.style.display = state.showEdges ? "block" : "none";
      });

      nodes.forEach((node, idx) => {
        const nodeEl = nodeEls[idx];
        const labelEl = labelEls[idx];
        const clusterName = node.cluster[state.clusterMode];
        const color = clusterColors.get(clusterName) || "#334155";

        nodeEl.setAttribute("cx", String(node.x));
        nodeEl.setAttribute("cy", String(node.y));
        nodeEl.setAttribute("fill", color);

        labelEl.setAttribute("x", String(node.x + 8));
        labelEl.setAttribute("y", String(node.y - 8));
        labelEl.setAttribute("class", state.showLabels ? "label" : "label hidden");

        const hoveredActive = hovered !== null && hovered !== undefined;
        const shouldDim = hoveredActive && !activeNeighbors.has(idx);
        const isFocused = (hoveredActive && idx === hovered) || searchHits.has(idx);
        nodeEl.classList.toggle("dimmed", shouldDim);
        nodeEl.classList.toggle("focused", isFocused);
      });
    }

    const edgeEls = buildEdgeElements();
    const { nodeEls, labelEls } = buildNodeElements();

    let clusterColors = buildClusterColorMap(state.clusterMode);
    let clusterCenters = buildClusterCenters(state.clusterMode);
    drawClusterLayer(state.clusterMode, clusterColors);
    updateLegend(state.clusterMode, clusterColors);
    resetNodePositions();
    updateDetailsPanel(null);

    function updateClusterMode() {
      clusterColors = buildClusterColorMap(state.clusterMode);
      clusterCenters = buildClusterCenters(state.clusterMode);
      drawClusterLayer(state.clusterMode, clusterColors);
      updateLegend(state.clusterMode, clusterColors);
      resetNodePositions();
      updateDetailsPanel(state.hovered);
    }

    clusterModeEl.addEventListener("change", () => {
      state.clusterMode = clusterModeEl.value;
      updateClusterMode();
    });
    showLabelsEl.addEventListener("change", () => {
      state.showLabels = showLabelsEl.checked;
    });
    showEdgesEl.addEventListener("change", () => {
      state.showEdges = showEdgesEl.checked;
    });
    searchEl.addEventListener("input", () => {
      state.search = searchEl.value || "";
    });
    resetEl.addEventListener("click", () => {
      resetNodePositions();
    });

    function frame() {
      applyForces(clusterCenters);
      drawFrame(nodeEls, labelEls, edgeEls, clusterColors, clusterCenters);
      window.requestAnimationFrame(frame);
    }
    frame();
  </script>
</body>
</html>
